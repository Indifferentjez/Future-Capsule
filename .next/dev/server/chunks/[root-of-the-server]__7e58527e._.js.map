{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/OneDrive/Desktop/Nostalgic%20Message%20to%20the%20future/lib/supabase/env.ts"],"sourcesContent":["/**\n * Supabase env validation. Throws a clear error listing missing vars.\n * Use one key: publishable (new) or anon (legacy).\n */\n\nconst URL = process.env.NEXT_PUBLIC_SUPABASE_URL;\nconst PUBLISHABLE = process.env.NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY;\nconst ANON = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY;\n\nexport const SUPABASE_URL = URL?.trim() || null;\nexport const SUPABASE_KEY = (PUBLISHABLE ?? ANON)?.trim() ?? null;\n\nexport function getSupabaseUrl(): string {\n  if (!SUPABASE_URL) {\n    const missing = [\"NEXT_PUBLIC_SUPABASE_URL\"];\n    throw new Error(\n      `Supabase URL is required. Missing env: ${missing.join(\", \")}. Set them in .env.local at project root.`\n    );\n  }\n  return SUPABASE_URL;\n}\n\nexport function getSupabaseKey(): string {\n  if (!SUPABASE_KEY) {\n    const missing = [\n      ...(PUBLISHABLE === undefined && ANON === undefined\n        ? [\"NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY\"]\n        : []),\n      ...(PUBLISHABLE === \"\" && ANON === \"\"\n        ? [\"NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY (empty)\"]\n        : []),\n    ];\n    if (missing.length === 0)\n      missing.push(\"NEXT_PUBLIC_SUPABASE_PUBLISHABLE_KEY or NEXT_PUBLIC_SUPABASE_ANON_KEY\");\n    throw new Error(\n      `Supabase key is required. Missing or empty env: ${missing.join(\", \")}. Set them in .env.local at project root.`\n    );\n  }\n  return SUPABASE_KEY;\n}\n\n/** Development-only: log whether URL/key are set (booleans only). */\nexport function logSupabaseEnvCheck(): void {\n  if (process.env.NODE_ENV !== \"development\") return;\n  // eslint-disable-next-line no-console\n  console.log(\"[Supabase env check]\", {\n    hasUrl: Boolean(SUPABASE_URL),\n    hasKey: Boolean(SUPABASE_KEY),\n  });\n}\n\nconst SERVICE_ROLE = process.env.SUPABASE_SERVICE_ROLE_KEY?.trim();\n\nexport function getSupabaseServiceRoleKey(): string {\n  if (!SERVICE_ROLE) {\n    throw new Error(\n      \"Supabase service role key is required. Missing env: SUPABASE_SERVICE_ROLE_KEY. Set it in .env.local at project root (server-side only).\"\n    );\n  }\n  return SERVICE_ROLE;\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;AAAA;;;CAGC,GAED,MAAM;AACN,MAAM,cAAc,QAAQ,GAAG,CAAC,oCAAoC;AACpE,MAAM;AAEC,MAAM,eAAe,KAAK,UAAU;AACpC,MAAM,eAAe,CAAC,eAAe,IAAI,GAAG,UAAU;AAEtD,SAAS;IACd,IAAI,CAAC,cAAc;QACjB,MAAM,UAAU;YAAC;SAA2B;QAC5C,MAAM,IAAI,MACR,CAAC,uCAAuC,EAAE,QAAQ,IAAI,CAAC,MAAM,yCAAyC,CAAC;IAE3G;IACA,OAAO;AACT;AAEO,SAAS;IACd,IAAI,CAAC,cAAc;QACjB,MAAM,UAAU;eACV,sCACA,0BACA,EAAE;eACF,sCACA,0BACA,EAAE;SACP;QACD,IAAI,QAAQ,MAAM,KAAK,GACrB,QAAQ,IAAI,CAAC;QACf,MAAM,IAAI,MACR,CAAC,gDAAgD,EAAE,QAAQ,IAAI,CAAC,MAAM,yCAAyC,CAAC;IAEpH;IACA,OAAO;AACT;AAGO,SAAS;IACd;;IACA,sCAAsC;IACtC,QAAQ,GAAG,CAAC,wBAAwB;QAClC,QAAQ,QAAQ;QAChB,QAAQ,QAAQ;IAClB;AACF;AAEA,MAAM,eAAe,QAAQ,GAAG,CAAC,yBAAyB,EAAE;AAErD,SAAS;IACd,IAAI,CAAC,cAAc;QACjB,MAAM,IAAI,MACR;IAEJ;IACA,OAAO;AACT"}},
    {"offset": {"line": 108, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/USER/OneDrive/Desktop/Nostalgic%20Message%20to%20the%20future/proxy.ts"],"sourcesContent":["import { createServerClient } from \"@supabase/ssr\";\nimport { NextResponse, type NextRequest } from \"next/server\";\nimport { getSupabaseUrl, getSupabaseKey } from \"@/lib/supabase/env\";\n\nconst protectedPaths = [\"/compose\", \"/inbox\"];\nconst authPaths = [\"/login\", \"/signup\"];\nconst GET_CLAIMS_TIMEOUT_MS = 3000;\nconst RETRY_DELAY_MS = 200;\n\nfunction genRid(): string {\n  return `rid_${Date.now().toString(36)}_${Math.random().toString(36).slice(2, 8)}`;\n}\n\nfunction isTransientError(e: unknown): boolean {\n  const msg = String((e as Error)?.message ?? e).toLowerCase();\n  const cause = (e as Error)?.cause;\n  const causeMsg = cause ? String((cause as Error)?.message ?? cause).toLowerCase() : \"\";\n  return (\n    msg.includes(\"econnreset\") ||\n    msg.includes(\"fetch failed\") ||\n    msg.includes(\"network\") ||\n    msg.includes(\"timeout\") ||\n    causeMsg.includes(\"econnreset\") ||\n    causeMsg.includes(\"fetch failed\")\n  );\n}\n\nfunction withTimeout<T>(promise: Promise<T>, ms: number): Promise<T> {\n  return new Promise((resolve, reject) => {\n    const t = setTimeout(() => reject(new Error(\"getClaims timeout\")), ms);\n    promise.then(\n      (v) => {\n        clearTimeout(t);\n        resolve(v);\n      },\n      (err) => {\n        clearTimeout(t);\n        reject(err);\n      }\n    );\n  });\n}\n\nexport async function proxy(request: NextRequest) {\n  const rid = genRid();\n  const path = request.nextUrl.pathname;\n  const response = NextResponse.next({ request });\n\n  let url: string;\n  let key: string;\n  try {\n    url = getSupabaseUrl();\n    key = getSupabaseKey();\n  } catch (e) {\n    if (process.env.NODE_ENV === \"development\") {\n      console.warn(\"[proxy] Supabase env missing, skipping auth:\", (e as Error).message);\n    }\n    return response;\n  }\n\n  const supabase = createServerClient(url, key, {\n    cookies: {\n      getAll() {\n        return request.cookies.getAll();\n      },\n      setAll(cookiesToSet) {\n        cookiesToSet.forEach(({ name, value, options }) => {\n          request.cookies.set(name, value);\n          response.cookies.set(name, value, options);\n        });\n      },\n    },\n  });\n\n  let user: { id: string } | null = null;\n  const start = Date.now();\n\n  const runGetClaims = async () => {\n    await withTimeout(supabase.auth.getClaims(), GET_CLAIMS_TIMEOUT_MS);\n    const { data } = await supabase.auth.getUser();\n    return data.user;\n  };\n\n  try {\n    try {\n      user = await runGetClaims();\n    } catch (firstErr) {\n      user = null;\n      if (isTransientError(firstErr)) {\n        await new Promise((r) => setTimeout(r, RETRY_DELAY_MS));\n        try {\n          user = await runGetClaims();\n        } catch {\n          user = null;\n        }\n      }\n    }\n  } catch (e) {\n    if (process.env.NODE_ENV === \"development\") {\n      const duration = Date.now() - start;\n      const code = (e as Error)?.cause ? String((e as Error).cause) : (e as Error)?.message;\n      console.warn(`[proxy] getClaims failed path=${path} rid=${rid} duration=${duration}ms`, code ?? e);\n    }\n    return response;\n  }\n\n  if (process.env.NODE_ENV === \"development\" && path !== \"/_next/webpack-hmr\" && !path.startsWith(\"/_next\")) {\n    const duration = Date.now() - start;\n    if (duration > 500) {\n      console.info(`[proxy] getClaims slow path=${path} rid=${rid} duration=${duration}ms`);\n    }\n  }\n\n  const isProtected = protectedPaths.some((p) => path.startsWith(p));\n  const isAuthPage = authPaths.some((p) => path.startsWith(p));\n\n  if (isProtected && !user) {\n    const redirect = new URL(\"/\", request.url);\n    redirect.searchParams.set(\"signin\", \"1\");\n    return NextResponse.redirect(redirect);\n  }\n  if (isAuthPage && user) {\n    return NextResponse.redirect(new URL(\"/inbox\", request.url));\n  }\n  return response;\n}\n\nexport const config = {\n  matcher: [\n    \"/((?!_next/static|_next/image|favicon.ico|assets|fonts|auth/callback|api).*)\",\n  ],\n};\n"],"names":[],"mappings":"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"}}]
}